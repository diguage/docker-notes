= Manage data in Docker

By default all files created inside a container are stored on a writable container layer. 

* The data doesn’t persist when that container no longer exists, be difficult to get the data out of the container.
* A container’s writable layer is tightly coupled to the host machine where the container is running. 
* Writing into a container’s writable layer requires a storage driver to manage the filesystem. This extra abstraction reduces performance as compared to using data volumes.

Docker has two options for containers to store files in the host machine: `volumes`, and `bind mounts`.


image::types-of-mounts.png[title="Docker storage", alt="Docker storage", width="95%"]

. *Volumes* are stored in a part of the host filesystem which is managed by Docker (`/var/lib/docker/volumes/` on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker.  Created and managed by Docker with `docker volume create`.
* *Bind mounts* may be stored anywhere on the host system. They may even be important system files or directories. Non-Docker processes on the Docker host or a Docker container can modify them at any time.
* `tmpfs` mounts are stored in the host system’s memory only, and are never written to the host system’s filesystem.

In Docker 17.06 and higher, we recommend using the `--mount` flag for both containers and services, for bind mounts, volumes, or `tmpfs` mounts, as the syntax is more clear.

*Good use cases for volumes*

* Sharing data among multiple running containers.
* When the Docker host is not guaranteed to have a given directory or file structure.
* When you want to store your container’s data on a remote host or a cloud provider, rather than locally.
* When you need to back up, restore, or migrate data from one Docker host to another, volumes are a better choice.

*Good use cases for bind mounts*

* Sharing configuration files from the host machine to containers.DNS resolution to containers by mounting `/etc/resolv.conf`.
* Sharing source code or build artifacts between a development environment on the Docker host and a container.
* When the file or directory structure of the Docker host is guaranteed to be consistent with the bind mounts the containers require.


`tmpfs` mounts are best used for cases when you do not want the data to persist either on the host machine or within the container. 


== volumes

Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. 

* Volumes are easier to back up or migrate than bind mounts.
* You can manage volumes using Docker CLI commands or the Docker API.
* Volumes work on both Linux and Windows containers.
* Volumes can be more safely shared among multiple containers.
* Volume drivers let you store volumes on remote hosts or cloud providers, to encrypt the contents of volumes, or to add other functionality.
* New volumes can have their content pre-populated by a container.

image::types-of-mounts-volume.png[title="Docker volumes", alt="Docker volumes", width="95%"]

A volume does not increase the size of the containers using it, and the volume’s contents exist outside the lifecycle of a given container.


Volumes use `rprivate` bind propagation.

NOTE: `rprivate` 是什么鬼？

In general, `--mount` is more explicit and verbose. The biggest difference is that the `-v` syntax combines all the options together in one field, while the `--mount` syntax separates them.

If you need to specify volume driver options, you must use `--mount`.

* `-v` or `--volume`: Consists of three fields, separated by colon characters (`:`). The fields must be in the correct order.
** The first field is the name of the volume, and is unique on a given host machine. 
** The second field is the path where the file or directory are mounted in the container.
** The third field is optional, and is a comma-separated list of options, such as `ro`.
* `--mount`: Consists of multiple key-value pairs, separated by commas and each consisting of a `<key>=<value>` tuple. 


When using volumes with services, only `--mount` is supported.

[source,bash]
----
# Create a volume:
$ docker volume create dgg-vol


# List volumes:
$ docker volume ls

# Inspect a volume:
$ docker volume inspect dgg-vol
[
    {
        "CreatedAt": "2019-03-31T15:56:58Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/dgg-vol/_data",
        "Name": "dgg-vol",
        "Options": {},
        "Scope": "local"
    }
]

# Remove a volume:
$ docker volume rm dgg-vol


$ docker run -d 
    --name devtest \
    --mount source=dggvol2,target=/app \
    nginx:latest

$ docker inspect devtest

$ docker container stop devtest
$ docker container rm devtest
$ docker volume rm dggvol2


$ docker service create -d \
    --replicas=4 \
    --name devtest-service \
    --mount source=dggvol2,target=/app \
    nginx:latest

$ docker service ps devtest-service

$ docker service rm devtest-service
----

The `docker service create` command does not support the `-v` or `--volume` flag.

[source,bash]
----
$ docker run -d \
    --name=nginxtest \
    --mount source=nginx-vol,destination=/usr/share/nginx/html \
    nginx:latest

$ docker container stop nginxtest

$ docker container rm nginxtest

$ docker volume rm nginx-vol

$ docker run -d \
    --name=nginxtest \
    --mount source=nginx-vol,destination=/usr/share/nginx/html,readonly \
    nginx:latest

$ docker container stop nginxtest

$ docker container rm nginxtest

$ docker volume rm nginx-vol
----

image::volumes-shared-storage.svg[title="shared storage", alt="shared storage", width="95%"]

=== Volume Driver

[source,bash]
----
# On the Docker host, install the `vieux/sshfs` plugin:
$ docker plugin install --grant-all-permissions vieux/sshfs

# Create a volume using a volume driver
$ docker volume create --driver vieux/sshfs \
    -o sshcmd=test@node2:/home/test \
    -o password=testpassword \
    sshvolume

# Start a container which creates a volume using a volume driver
$ docker run -d \
    --name sshfs-container \
    --volume-driver vieux/sshfs \
    --mount src=sshvolume,target=/app,volume-opt=sshcmd=test@node2:/home/test,volume-opt=password=testpassword \
    nginx:latest

# NFSV3
$ docker service create -d \
    --name nfs-service \
    --mount 'type=volume,source=nfsvolume,target=/app,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/var/docker-nfs,volume-opt=o=addr=10.0.0.10' \
    nginx:latest

# NFSV4
$ docker service create -d \
    --name nfs-service \
    --mount 'type=volume,source=nfsvolume,target=/app,volume-driver=local,volume-opt=type=nfs,volume-opt=device=:/,"volume-opt=o=10.0.0.10,rw,nfsvers=4,async"' \
    nginx:latest`

# Backup a container
$ docker run --rm --volumes-from dbstore -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /dbdata <1>

# Restore container from backup
$ docker run -v /dbdata --name dbstore2 ubuntu /bin/bash <1>

$ docker run --rm --volumes-from dbstore2 -v $(pwd):/backup ubuntu bash -c "cd /dbdata && tar xvf /backup/backup.tar --strip 1" <1>

# To remove all unused volumes and free up space:
$ docker volume prune
----
<1> 不是很清楚！

NOTE: `docker plugin` 是什么鬼？

== 


























FROM ubuntu:latest
CMD ["/bin/echo", "Hello, D瓜哥！"]



